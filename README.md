# Микросервис для скачивания файлов

Микросервис помогает работе основного сайта, сделанного на CMS и обслуживает
запросы на скачивание архивов с файлами. Микросервис не умеет ничего, кроме упаковки файлов
в архив. Закачиваются файлы на сервер через FTP или админку CMS.

Создание архива происходит на лету по запросу от пользователя. Архив не сохраняется на диске, вместо этого по мере упаковки он сразу отправляется пользователю на скачивание.

От неавторизованного доступа архив защищен хешом в адресе ссылки на скачивание, например: `http://host.ru/archive/3bea29ccabbbf64bdebcc055319c5745/`. Хеш задается названием каталога с файлами, выглядит структура каталога так:

```
- photos
    - 3bea29ccabbbf64bdebcc055319c5745
      - 1.jpg
      - 2.jpg
      - 3.jpg
    - af1ad8c76fda2e48ea9aed2937e972ea
      - 1.jpg
      - 2.jpg
```


## Как установить

Для работы микросервиса нужен Python версии не ниже 3.10.  
Для настройки локального окружения нужно установить Poetry.

```bash
poetry install
```

## Как запустить web-сервер

```bash
poetry run python server.py --level info --debug
```
Параметры:
* level - отвечает за уровень логирования. Возможные значения `debug`, `info`, `warning`, `error`. По умолчанию - `info`.
* debug - включает режим отладки. По умолчанию отключен. Если включен, то включается задержка при скачивании файлов.  

Подробнее о параметрах:  
```bash
python server.py -h
```

Все папки для архивации ищутся в директории, указанной в переменной окружения PHOTOS_DIR. Если она не задана, то директория по умолчанию `test_photos/`  


Сервер запустится на порту 8080, чтобы проверить его работу перейдите в браузере на страницу [http://127.0.0.1:8080/](http://127.0.0.1:8080/).

## Как развернуть на сервере

Для запуска проекта на сервере необходимо установить docker и docker-compose.  
Перед запуском сервера нужно задать в файле .env переменную PHOTOS_DIR, в которой указать путь до директории с папками файлов для архивации.  
```bash
docker-compose up --build
```

После этого перенаправить на микросервис запросы, начинающиеся с `/archive/`. Например:

```
GET http://host.ru/archive/3bea29ccabbbf64bdebcc055319c5745/
GET http://host.ru/archive/af1ad8c76fda2e48ea9aed2937e972ea/
```

## Консольный скрипт main.py
Скрипт архивирует указанные в командной строке файлы в zip-файл.  
### Интерфейс командной строки
python main.py файл1 .... файлN [--save имя_архива]  
Пример
```bash
python main.py cities nature peoples --save archive.zip
```

# Цели проекта

Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).